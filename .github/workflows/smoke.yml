name: Business Smoke

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Start nopCommerce (Docker)
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for nopCommerce to be ready (not install page)
        run: |
          for i in {1..90}; do
            html="$(curl -fsS http://localhost:5000 || true)"
            if echo "$html" | grep -qi "nopCommerce"; then
              if echo "$html" | grep -qi "installation"; then
                echo "Still on install page"
              else
                echo "nopCommerce is up (not install page)!"
                exit 0
              fi
            fi
            echo "Waiting for nopCommerce... ($i)"
            sleep 2
          done

          echo "nopCommerce not ready"
          docker compose logs --no-color nopcommerce || true
          docker compose logs --no-color sqlserver || true
          exit 1

      - name: Run tests (headless)
        run: mvn -Dheadless=true test

      - name: Print surefire reports
        if: failure()
        run: |
          echo "=== Surefire reports ==="
          ls -la target/surefire-reports || true

          echo "=== Dump *.txt (if any) ==="
          for f in target/surefire-reports/*.txt; do
            echo "----- $f -----"
            cat "$f" || true
          done

          echo "=== Dump TEST-*.xml headers ==="
          for f in target/surefire-reports/TEST-*.xml; do
            echo "----- $f -----"
            head -n 80 "$f" || true
          done

      - name: Docker logs (nopcommerce + sqlserver)
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color nopcommerce || true
          docker compose logs --no-color sqlserver || true

      - name: Shutdown docker
        if: always()
        run: docker compose down -v
