name: Business Smoke

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      - name: Start nopCommerce (Docker)
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for nopCommerce to be ready (debug, follow redirects)
        run: |
          for i in {1..90}; do
            code="$(curl -s -L -o /tmp/page.html -w "%{http_code}" http://localhost:5000 || true)"
            final_url="$(curl -s -L -o /dev/null -w "%{url_effective}" http://localhost:5000 || true)"
            echo "HTTP: $code (try $i) URL: $final_url"
          
            if [ "$code" = "200" ]; then
              if echo "$final_url" | grep -qi "/install"; then
                echo "Still on install page"
              else
                echo "nopCommerce is up!"
                exit 0
              fi
            fi
          
            sleep 2
          done
          
          echo "nopCommerce not ready after 180s"
          echo "=== curl headers (follow redirects) ==="
          curl -i -L http://localhost:5000 || true
          echo "=== first 80 lines of HTML ==="
          head -n 80 /tmp/page.html || true
          echo "=== docker compose ps ==="
          docker compose ps || true
          echo "=== nopcommerce logs ==="
          docker compose logs --no-color nopcommerce || true
          echo "=== sqlserver logs (last 200 lines) ==="
          docker compose logs --no-color --tail=200 sqlserver || true
          exit 1
      

      - name: Run tests (headless)
        run: mvn -Dheadless=true test

      - name: Print surefire reports
        if: failure()
        run: |
          echo "=== Surefire reports ==="
          ls -la target/surefire-reports || true

          echo "=== Dump *.txt (if any) ==="
          for f in target/surefire-reports/*.txt; do
            echo "----- $f -----"
            cat "$f" || true
          done

          echo "=== Dump TEST-*.xml headers ==="
          for f in target/surefire-reports/TEST-*.xml; do
            echo "----- $f -----"
            head -n 80 "$f" || true
          done

      - name: Docker logs (nopcommerce + sqlserver)
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color nopcommerce || true
          docker compose logs --no-color sqlserver || true

      - name: Shutdown docker
        if: always()
        run: docker compose down -v
